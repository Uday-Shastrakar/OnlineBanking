server:
  port: 8080

spring:
  application:
    name: api-gateway
  
  cloud:
    gateway:
      # Disable local JWT validation - ALWAYS use Auth Service
      default-filters:
        - TokenRelay=
      
      routes:
        # Authentication Routes (Public - No auth required)
        - id: auth-service
          uri: http://localhost:9093
          predicates:
            - Path=/api/auth/**
          filters:
            - StripPrefix=0
          metadata:
            name: Authentication Service
            public: true
        
        # Customer Service Routes (Strict auth + authorization)
        - id: customer-service
          uri: http://localhost:9094
          predicates:
            - Path=/api/customer/**
          filters:
            - StripPrefix=0
            - StrictAuthenticationFilter
            - AuthorizationFilter=CUSTOMER_READ,CUSTOMER_WRITE,ADMIN_ALL
          metadata:
            name: Customer Service
            permissions: [CUSTOMER_READ, CUSTOMER_WRITE, ADMIN_ALL]
        
        # Account Service Routes
        - id: account-service
          uri: http://localhost:9095
          predicates:
            - Path=/api/account/**
          filters:
            - StripPrefix=0
            - StrictAuthenticationFilter
            - AuthorizationFilter=ACCOUNT_READ,ACCOUNT_WRITE,ADMIN_ALL
          metadata:
            name: Account Service
            permissions: [ACCOUNT_READ, ACCOUNT_WRITE, ADMIN_ALL]
        
        # Transaction Service Routes
        - id: transaction-service
          uri: http://localhost:9096
          predicates:
            - Path=/api/transaction/**
          filters:
            - StripPrefix=0
            - StrictAuthenticationFilter
            - AuthorizationFilter=TRANSACTION_EXECUTE,ADMIN_ALL
            - IdempotencyFilter
          metadata:
            name: Transaction Service
            permissions: [TRANSACTION_EXECUTE, ADMIN_ALL]
        
        # Audit Service Routes (Admin/Auditor only)
        - id: audit-service
          uri: http://localhost:9099
          predicates:
            - Path=/api/audit/**
          filters:
            - StripPrefix=0
            - StrictAuthenticationFilter
            - AuthorizationFilter=AUDIT_READ,ADMIN_ALL
          metadata:
            name: Audit Service
            permissions: [AUDIT_READ, ADMIN_ALL]
        
        # User Management Routes (Admin only)
        - id: user-service
          uri: http://localhost:9093
          predicates:
            - Path=/api/users/**
          filters:
            - StripPrefix=0
            - StrictAuthenticationFilter
            - AuthorizationFilter=USER_MANAGE,ADMIN_ALL
          metadata:
            name: User Management Service
            permissions: [USER_MANAGE, ADMIN_ALL]
        
        # User-Customer Mapping Routes
        - id: mapping-service
          uri: http://localhost:9093
          predicates:
            - Path=/api/user-customer-mapping/**
          filters:
            - StripPrefix=0
            - StrictAuthenticationFilter
            - AuthorizationFilter=CUSTOMER_READ,ADMIN_ALL
          metadata:
            name: User-Customer Mapping Service
            permissions: [CUSTOMER_READ, ADMIN_ALL]

  # Redis for token revocation and caching
  redis:
    host: localhost
    port: 6379
    timeout: 2000ms
    lettuce:
      pool:
        max-active: 8
        max-idle: 8
        min-idle: 0

# Security Headers
security:
  headers:
    content-type:
      policy: application/json
    frame-options:
      policy: DENY
    xss-protection:
      policy: "1; mode=block"
    referrer-policy:
      policy: strict-origin-when-cross-origin
    content-security-policy:
      policy: "default-src 'self'; script-src 'self' 'unsafe-inline'"

# Logging
logging:
  level:
    com.banking.gateway: DEBUG
    org.springframework.cloud.gateway: DEBUG
    org.springframework.web.reactive.function.client: DEBUG

# Management endpoints
management:
  endpoints:
    web:
      exposure:
        include: health,info,gateway
  endpoint:
    health:
      show-details: always
