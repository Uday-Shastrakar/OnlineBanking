package com.bank.authentication.controller;

import com.bank.authentication.dto.TokenIntrospectionRequest;
import com.bank.authentication.dto.TokenRevocationRequest;
import com.bank.authentication.dto.TokenValidationResponse;
import com.bank.authentication.model.User;
import com.bank.authentication.service.JwtTokenService;
import com.bank.authentication.service.TokenRevocationService;
import com.bank.authentication.service.UserService;
import com.fasterxml.jackson.databind.ObjectMapper;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.junit.jupiter.MockitoExtension;
import org.springframework.http.MediaType;
import org.springframework.test.web.reactive.server.WebTestClient;
import org.springframework.web.server.ServerWebExchange;
import reactor.core.publisher.Mono;

import java.time.Instant;
import java.util.Arrays;
import java.util.Set;

import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.ArgumentMatchers.*;
import static org.mockito.Mockito.*;

/**
 * Token Introspection Controller Test Cases
 * Tests the SINGLE SOURCE OF TRUTH for token validation
 */
@ExtendWith(MockitoExtension.class)
class TokenIntrospectionControllerTest {

    @Mock
    private JwtTokenService jwtTokenService;

    @Mock
    private UserService userService;

    @Mock
    private TokenRevocationService tokenRevocationService;

    @InjectMocks
    private TokenIntrospectionController tokenIntrospectionController;

    private WebTestClient webTestClient;
    private ObjectMapper objectMapper;

    @BeforeEach
    void setUp() {
        webTestClient = WebTestClient.bindToController(tokenIntrospectionController).build();
        objectMapper = new ObjectMapper();
    }

    @Test
    void testValidTokenIntrospection_ShouldReturnValidResponse() {
        // Given
        String validToken = "valid.jwt.token";
        TokenIntrospectionRequest request = TokenIntrospectionRequest.builder()
                .token(validToken)
                .build();

        User mockUser = createMockUser();
        var mockClaims = createMockClaims();

        when(jwtTokenService.parseClaims(validToken))
                .thenReturn(mockClaims);
        when(jwtTokenService.validateSignature(mockClaims))
                .thenReturn(true);
        when(userService.findById(123L))
                .thenReturn(mockUser);
        when(tokenRevocationService.isRevoked("token-123"))
                .thenReturn(false);

        // When & Then
        webTestClient.post()
                .uri("/api/auth/introspect")
                .contentType(MediaType.APPLICATION_JSON)
                .bodyValue(request)
                .exchange()
                .expectStatus().isOk()
                .expectBody(TokenValidationResponse.class)
                .value(response -> {
                    assertTrue(response.isValid());
                    assertEquals("token-123", response.getTokenId());
                    assertEquals(123L, response.getUserId());
                    assertEquals("testuser", response.getUsername());
                    assertEquals(Set.of("CUSTOMER_USER"), response.getRoles());
                    assertEquals(Set.of("CUSTOMER_READ", "CUSTOMER_WRITE"), response.getPermissions());
                    assertEquals("ACTIVE", response.getUserStatus());
                });
    }

    @Test
    void testInvalidSignatureToken_ShouldReturnInvalidResponse() {
        // Given
        String invalidToken = "invalid.signature.token";
        TokenIntrospectionRequest request = TokenIntrospectionRequest.builder()
                .token(invalidToken)
                .build();

        var mockClaims = createMockClaims();

        when(jwtTokenService.parseClaims(invalidToken))
                .thenReturn(mockClaims);
        when(jwtTokenService.validateSignature(mockClaims))
                .thenReturn(false);

        // When & Then
        webTestClient.post()
                .uri("/api/auth/introspect")
                .contentType(MediaType.APPLICATION_JSON)
                .bodyValue(request)
                .exchange()
                .expectStatus().isOk()
                .expectBody(TokenValidationResponse.class)
                .value(response -> {
                    assertFalse(response.isValid());
                    assertEquals("Invalid token signature", response.getErrorMessage());
                });
    }

    @Test
    void testExpiredToken_ShouldReturnInvalidResponse() {
        // Given
        String expiredToken = "expired.jwt.token";
        TokenIntrospectionRequest request = TokenIntrospectionRequest.builder()
                .token(expiredToken)
                .build();

        var mockClaims = createMockClaims();
        mockClaims.setExpiration(java.util.Date.from(Instant.now().minusSeconds(3600))); // Expired 1 hour ago

        when(jwtTokenService.parseClaims(expiredToken))
                .thenReturn(mockClaims);
        when(jwtTokenService.validateSignature(mockClaims))
                .thenReturn(true);

        // When & Then
        webTestClient.post()
                .uri("/api/auth/introspect")
                .contentType(MediaType.APPLICATION_JSON)
                .bodyValue(request)
                .exchange()
                .expectStatus().isOk()
                .expectBody(TokenValidationResponse.class)
                .value(response -> {
                    assertFalse(response.isValid());
                    assertEquals("Token expired", response.getErrorMessage());
                });
    }

    @Test
    void testUserNotFound_ShouldReturnInvalidResponse() {
        // Given
        String validToken = "valid.jwt.token";
        TokenIntrospectionRequest request = TokenIntrospectionRequest.builder()
                .token(validToken)
                .build();

        var mockClaims = createMockClaims();

        when(jwtTokenService.parseClaims(validToken))
                .thenReturn(mockClaims);
        when(jwtTokenService.validateSignature(mockClaims))
                .thenReturn(true);
        when(userService.findById(123L))
                .thenReturn(null); // User not found

        // When & Then
        webTestClient.post()
                .uri("/api/auth/introspect")
                .contentType(MediaType.APPLICATION_JSON)
                .bodyValue(request)
                .exchange()
                .expectStatus().isOk()
                .expectBody(TokenValidationResponse.class)
                .value(response -> {
                    assertFalse(response.isValid());
                    assertEquals("User not found or inactive", response.getErrorMessage());
                });
    }

    @Test
    void testInactiveUser_ShouldReturnInvalidResponse() {
        // Given
        String validToken = "valid.jwt.token";
        TokenIntrospectionRequest request = TokenIntrospectionRequest.builder()
                .token(validToken)
                .build();

        User inactiveUser = createMockUser();
        inactiveUser.setStatus(User.Status.INACTIVE);

        var mockClaims = createMockClaims();

        when(jwtTokenService.parseClaims(validToken))
                .thenReturn(mockClaims);
        when(jwtTokenService.validateSignature(mockClaims))
                .thenReturn(true);
        when(userService.findById(123L))
                .thenReturn(inactiveUser);

        // When & Then
        webTestClient.post()
                .uri("/api/auth/introspect")
                .contentType(MediaType.APPLICATION_JSON)
                .bodyValue(request)
                .exchange()
                .expectStatus().isOk()
                .expectBody(TokenValidationResponse.class)
                .value(response -> {
                    assertFalse(response.isValid());
                    assertEquals("User not found or inactive", response.getErrorMessage());
                });
    }

    @Test
    void testRevokedToken_ShouldReturnInvalidResponse() {
        // Given
        String revokedToken = "revoked.jwt.token";
        TokenIntrospectionRequest request = TokenIntrospectionRequest.builder()
                .token(revokedToken)
                .build();

        var mockClaims = createMockClaims();

        when(jwtTokenService.parseClaims(revokedToken))
                .thenReturn(mockClaims);
        when(jwtTokenService.validateSignature(mockClaims))
                .thenReturn(true);
        when(userService.findById(123L))
                .thenReturn(createMockUser());
        when(tokenRevocationService.isRevoked("token-123"))
                .thenReturn(true); // Token is revoked

        // When & Then
        webTestClient.post()
                .uri("/api/auth/introspect")
                .contentType(MediaType.APPLICATION_JSON)
                .bodyValue(request)
                .exchange()
                .expectStatus().isOk()
                .expectBody(TokenValidationResponse.class)
                .value(response -> {
                    assertFalse(response.isValid());
                    assertEquals("Token has been revoked", response.getErrorMessage());
                });
    }

    @Test
    void testMalformedToken_ShouldReturnInvalidResponse() {
        // Given
        String malformedToken = "malformed.token";
        TokenIntrospectionRequest request = TokenIntrospectionRequest.builder()
                .token(malformedToken)
                .build();

        when(jwtTokenService.parseClaims(malformedToken))
                .thenThrow(new RuntimeException("Malformed token"));

        // When & Then
        webTestClient.post()
                .uri("/api/auth/introspect")
                .contentType(MediaType.APPLICATION_JSON)
                .bodyValue(request)
                .exchange()
                .expectStatus().isOk()
                .expectBody(TokenValidationResponse.class)
                .value(response -> {
                    assertFalse(response.isValid());
                    assertEquals("Invalid token", response.getErrorMessage());
                });
    }

    @Test
    void testRevokeToken_ShouldReturnSuccess() {
        // Given
        String validToken = "valid.jwt.token";
        TokenRevocationRequest request = TokenRevocationRequest.builder()
                .token(validToken)
                .reason("User logout")
                .build();

        var mockClaims = createMockClaims();

        when(jwtTokenService.parseClaims(validToken))
                .thenReturn(mockClaims);

        // When & Then
        webTestClient.post()
                .uri("/api/auth/revoke")
                .contentType(MediaType.APPLICATION_JSON)
                .bodyValue(request)
                .exchange()
                .expectStatus().isOk();

        verify(tokenRevocationService).revokeToken("token-123", "User logout");
    }

    @Test
    void testRevokeInvalidToken_ShouldReturnBadRequest() {
        // Given
        String invalidToken = "invalid.token";
        TokenRevocationRequest request = TokenRevocationRequest.builder()
                .token(invalidToken)
                .reason("User logout")
                .build();

        when(jwtTokenService.parseClaims(invalidToken))
                .thenThrow(new RuntimeException("Invalid token"));

        // When & Then
        webTestClient.post()
                .uri("/api/auth/revoke")
                .contentType(MediaType.APPLICATION_JSON)
                .bodyValue(request)
                .exchange()
                .expectStatus().isBadRequest();
    }

    @Test
    void testCheckTokenRevoked_ShouldReturnFalseForActiveToken() {
        // Given
        String tokenId = "active-token-123";

        when(tokenRevocationService.isRevoked(tokenId))
                .thenReturn(false);

        // When & Then
        webTestClient.get()
                .uri("/api/auth/revoked/" + tokenId)
                .exchange()
                .expectStatus().isOk()
                .expectBody(Boolean.class)
                .value(isFalse);
    }

    @Test
    void testCheckTokenRevoked_ShouldReturnTrueForRevokedToken() {
        // Given
        String tokenId = "revoked-token-123";

        when(tokenRevocationService.isRevoked(tokenId))
                .thenReturn(true);

        // When & Then
        webTestClient.get()
                .uri("/api/auth/revoked/" + tokenId)
                .exchange()
                .expectStatus().isOk()
                .expectBody(Boolean.class)
                .value(isTrue);
    }

    @Test
    void testAdminUserTokenIntrospection_ShouldReturnAdminPermissions() {
        // Given
        String adminToken = "admin.jwt.token";
        TokenIntrospectionRequest request = TokenIntrospectionRequest.builder()
                .token(adminToken)
                .build();

        User adminUser = createMockAdminUser();
        var mockClaims = createMockClaims();

        when(jwtTokenService.parseClaims(adminToken))
                .thenReturn(mockClaims);
        when(jwtTokenService.validateSignature(mockClaims))
                .thenReturn(true);
        when(userService.findById(1L))
                .thenReturn(adminUser);
        when(tokenRevocationService.isRevoked("token-123"))
                .thenReturn(false);

        // When & Then
        webTestClient.post()
                .uri("/api/auth/introspect")
                .contentType(MediaType.APPLICATION_JSON)
                .bodyValue(request)
                .exchange()
                .expectStatus().isOk()
                .expectBody(TokenValidationResponse.class)
                .value(response -> {
                    assertTrue(response.isValid());
                    assertEquals(1L, response.getUserId());
                    assertEquals("admin", response.getUsername());
                    assertEquals(Set.of("ADMIN"), response.getRoles());
                    assertEquals(Set.of("ADMIN_ALL"), response.getPermissions());
                    assertEquals("ACTIVE", response.getUserStatus());
                });
    }

    @Test
    void testAuditorUserTokenIntrospection_ShouldReturnAuditorPermissions() {
        // Given
        String auditorToken = "auditor.jwt.token";
        TokenIntrospectionRequest request = TokenIntrospectionRequest.builder()
                .token(auditorToken)
                .build();

        User auditorUser = createMockAuditorUser();
        var mockClaims = createMockClaims();

        when(jwtTokenService.parseClaims(auditorToken))
                .thenReturn(mockClaims);
        when(jwtTokenService.validateSignature(mockClaims))
                .thenReturn(true);
        when(userService.findById(2L))
                .thenReturn(auditorUser);
        when(tokenRevocationService.isRevoked("token-123"))
                .thenReturn(false);

        // When & Then
        webTestClient.post()
                .uri("/api/auth/introspect")
                .contentType(MediaType.APPLICATION_JSON)
                .bodyValue(request)
                .exchange()
                .expectStatus().isOk()
                .expectBody(TokenValidationResponse.class)
                .value(response -> {
                    assertTrue(response.isValid());
                    assertEquals(2L, response.getUserId());
                    assertEquals("auditor", response.getUsername());
                    assertEquals(Set.of("AUDITOR"), response.getRoles());
                    assertEquals(Set.of("AUDIT_READ"), response.getPermissions());
                    assertEquals("ACTIVE", response.getUserStatus());
                });
    }

    // Helper methods
    private User createMockUser() {
        User user = new User();
        user.setUserId(123L);
        user.setUsername("testuser");
        user.setStatus(User.Status.ACTIVE);
        // Set roles and permissions as needed
        return user;
    }

    private User createMockAdminUser() {
        User user = new User();
        user.setUserId(1L);
        user.setUsername("admin");
        user.setStatus(User.Status.ACTIVE);
        // Set admin roles and permissions
        return user;
    }

    private User createMockAuditorUser() {
        User user = new User();
        user.setUserId(2L);
        user.setUsername("auditor");
        user.setStatus(User.Status.ACTIVE);
        // Set auditor roles and permissions
        return user;
    }

    private MockJwtClaims createMockClaims() {
        // Create mock JWT claims
        // This would need to be implemented based on your JWT library
        // For now, we'll use a simple mock implementation
        return new MockJwtClaims();
    }

    // Mock JWT Claims class
    private static class MockJwtClaims {
        private String id = "token-123";
        private String subject = "123";
        private java.util.Date expiration = java.util.Date.from(Instant.now().plusSeconds(3600));
        private java.util.Date issuedAt = java.util.Date.from(Instant.now());

        public String getId() { return id; }
        public String getSubject() { return subject; }
        public java.util.Date getExpiration() { return expiration; }
        public java.util.Date getIssuedAt() { return issuedAt; }
    }
}
